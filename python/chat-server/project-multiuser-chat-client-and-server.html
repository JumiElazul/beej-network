<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Beej's Guide to Network Concepts</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!-- Generated by the mklightdark script -->
  <!-- Modify that script to change syntax highlighting -->
    <style>
     @media (prefers-color-scheme: light) {
      html {
        color: #1a1a1a;
        background-color: #fdfdfd;
      }
      body {
        margin: 0 auto;
        max-width: 36em;
        padding-left: 50px;
        padding-right: 50px;
        padding-top: 50px;
        padding-bottom: 50px;
        hyphens: auto;
        overflow-wrap: break-word;
        text-rendering: optimizeLegibility;
        font-kerning: normal;
      }
      @media (max-width: 600px) {
        body {
          font-size: 0.9em;
          padding: 12px;
        }
        h1 {
          font-size: 1.8em;
        }
      }
      @media print {
        html {
          background-color: white;
        }
        body {
          background-color: transparent;
          color: black;
          font-size: 12pt;
        }
        p, h2, h3 {
          orphans: 3;
          widows: 3;
        }
        h2, h3, h4 {
          page-break-after: avoid;
        }
      }
      p {
        margin: 1em 0;
      }
      a {
        color: #1a1a1a;
      }
      a:visited {
        color: #1a1a1a;
      }
      img {
        max-width: 100%;
      }
      svg {
        height: auto;
        max-width: 100%;
      }
      h1, h2, h3, h4, h5, h6 {
        margin-top: 1.4em;
      }
      h5, h6 {
        font-size: 1em;
        font-style: italic;
      }
      h6 {
        font-weight: normal;
      }
      ol, ul {
        padding-left: 1.7em;
        margin-top: 1em;
      }
      li > ol, li > ul {
        margin-top: 0;
      }
      blockquote {
        margin: 1em 0 1em 1.7em;
        padding-left: 1em;
        border-left: 2px solid #e6e6e6;
        color: #606060;
      }
      code {
        font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
        font-size: 85%;
        margin: 0;
        hyphens: manual;
      }
      pre {
        margin: 1em 0;
        overflow: auto;
      }
      pre code {
        padding: 0;
        overflow: visible;
        overflow-wrap: normal;
      }
      .sourceCode {
       background-color: transparent;
       overflow: visible;
      }
      hr {
        background-color: #1a1a1a;
        border: none;
        height: 1px;
        margin: 1em 0;
      }
      table {
        margin: 1em 0;
        border-collapse: collapse;
        width: 100%;
        overflow-x: auto;
        display: block;
        font-variant-numeric: lining-nums tabular-nums;
      }
      table caption {
        margin-bottom: 0.75em;
      }
      tbody {
        margin-top: 0.5em;
        border-top: 1px solid #1a1a1a;
        border-bottom: 1px solid #1a1a1a;
      }
      th {
        border-top: 1px solid #1a1a1a;
        padding: 0.25em 0.5em 0.25em 0.5em;
      }
      td {
        padding: 0.125em 0.5em 0.25em 0.5em;
      }
      header {
        margin-bottom: 4em;
        text-align: center;
      }
      #TOC li {
        list-style: none;
      }
      #TOC ul {
        padding-left: 1.3em;
      }
      #TOC > ul {
        padding-left: 0;
      }
      #TOC a:not(:hover) {
        text-decoration: none;
      }
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      div.columns{display: flex; gap: min(4vw, 1.5em);}
      div.column{flex: auto; overflow-x: auto;}
      div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
      /* The extra [class] is a hack that increases specificity enough to
         override a similar rule in reveal.js */
      ul.task-list[class]{list-style: none;}
      ul.task-list li input[type="checkbox"] {
        font-size: inherit;
        width: 0.8em;
        margin: 0 0.8em 0.2em -1.6em;
        vertical-align: middle;
      }
      .display.math{display: block; text-align: center; margin: 0.5rem auto;}
      /* CSS for syntax highlighting */
      html { -webkit-text-size-adjust: 100%; }
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
          color: #aaaaaa;
        }
      pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
      div.sourceCode
        {   }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      code span.al { color: #ff0000; font-weight: bold; } /* Alert */
      code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
      code span.at { color: #7d9029; } /* Attribute */
      code span.bn { color: #40a070; } /* BaseN */
      code span.bu { color: #008000; } /* BuiltIn */
      code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
      code span.ch { color: #4070a0; } /* Char */
      code span.cn { color: #880000; } /* Constant */
      code span.co { color: #60a0b0; font-style: italic; } /* Comment */
      code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
      code span.do { color: #ba2121; font-style: italic; } /* Documentation */
      code span.dt { color: #902000; } /* DataType */
      code span.dv { color: #40a070; } /* DecVal */
      code span.er { color: #ff0000; font-weight: bold; } /* Error */
      code span.ex { } /* Extension */
      code span.fl { color: #40a070; } /* Float */
      code span.fu { color: #06287e; } /* Function */
      code span.im { color: #008000; font-weight: bold; } /* Import */
      code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
      code span.kw { color: #007020; font-weight: bold; } /* Keyword */
      code span.op { color: #666666; } /* Operator */
      code span.ot { color: #007020; } /* Other */
      code span.pp { color: #bc7a00; } /* Preprocessor */
      code span.sc { color: #4070a0; } /* SpecialChar */
      code span.ss { color: #bb6688; } /* SpecialString */
      code span.st { color: #4070a0; } /* String */
      code span.va { color: #19177c; } /* Variable */
      code span.vs { color: #4070a0; } /* VerbatimString */
      code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
      }
    </style>
    <style>
     @media (prefers-color-scheme: dark) {
      html {
        color: #1a1a1a;
        background-color: #fdfdfd;
      }
      body {
        margin: 0 auto;
        max-width: 36em;
        padding-left: 50px;
        padding-right: 50px;
        padding-top: 50px;
        padding-bottom: 50px;
        hyphens: auto;
        overflow-wrap: break-word;
        text-rendering: optimizeLegibility;
        font-kerning: normal;
      }
      @media (max-width: 600px) {
        body {
          font-size: 0.9em;
          padding: 12px;
        }
        h1 {
          font-size: 1.8em;
        }
      }
      @media print {
        html {
          background-color: white;
        }
        body {
          background-color: transparent;
          color: black;
          font-size: 12pt;
        }
        p, h2, h3 {
          orphans: 3;
          widows: 3;
        }
        h2, h3, h4 {
          page-break-after: avoid;
        }
      }
      p {
        margin: 1em 0;
      }
      a {
        color: #1a1a1a;
      }
      a:visited {
        color: #1a1a1a;
      }
      img {
        max-width: 100%;
      }
      svg {
        height: auto;
        max-width: 100%;
      }
      h1, h2, h3, h4, h5, h6 {
        margin-top: 1.4em;
      }
      h5, h6 {
        font-size: 1em;
        font-style: italic;
      }
      h6 {
        font-weight: normal;
      }
      ol, ul {
        padding-left: 1.7em;
        margin-top: 1em;
      }
      li > ol, li > ul {
        margin-top: 0;
      }
      blockquote {
        margin: 1em 0 1em 1.7em;
        padding-left: 1em;
        border-left: 2px solid #e6e6e6;
        color: #606060;
      }
      code {
        font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
        font-size: 85%;
        margin: 0;
        hyphens: manual;
      }
      pre {
        margin: 1em 0;
        overflow: auto;
      }
      pre code {
        padding: 0;
        overflow: visible;
        overflow-wrap: normal;
      }
      .sourceCode {
       background-color: transparent;
       overflow: visible;
      }
      hr {
        background-color: #1a1a1a;
        border: none;
        height: 1px;
        margin: 1em 0;
      }
      table {
        margin: 1em 0;
        border-collapse: collapse;
        width: 100%;
        overflow-x: auto;
        display: block;
        font-variant-numeric: lining-nums tabular-nums;
      }
      table caption {
        margin-bottom: 0.75em;
      }
      tbody {
        margin-top: 0.5em;
        border-top: 1px solid #1a1a1a;
        border-bottom: 1px solid #1a1a1a;
      }
      th {
        border-top: 1px solid #1a1a1a;
        padding: 0.25em 0.5em 0.25em 0.5em;
      }
      td {
        padding: 0.125em 0.5em 0.25em 0.5em;
      }
      header {
        margin-bottom: 4em;
        text-align: center;
      }
      #TOC li {
        list-style: none;
      }
      #TOC ul {
        padding-left: 1.3em;
      }
      #TOC > ul {
        padding-left: 0;
      }
      #TOC a:not(:hover) {
        text-decoration: none;
      }
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      div.columns{display: flex; gap: min(4vw, 1.5em);}
      div.column{flex: auto; overflow-x: auto;}
      div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
      /* The extra [class] is a hack that increases specificity enough to
         override a similar rule in reveal.js */
      ul.task-list[class]{list-style: none;}
      ul.task-list li input[type="checkbox"] {
        font-size: inherit;
        width: 0.8em;
        margin: 0 0.8em 0.2em -1.6em;
        vertical-align: middle;
      }
      .display.math{display: block; text-align: center; margin: 0.5rem auto;}
      /* CSS for syntax highlighting */
      html { -webkit-text-size-adjust: 100%; }
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
        }
      pre.numberSource { margin-left: 3em;  padding-left: 4px; }
      div.sourceCode
        { color: #cccccc; background-color: #303030; }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      code span.al { color: #ffcfaf; } /* Alert */
      code span.an { color: #7f9f7f; font-weight: bold; } /* Annotation */
      code span.at { } /* Attribute */
      code span.bn { color: #dca3a3; } /* BaseN */
      code span.bu { } /* BuiltIn */
      code span.cf { color: #f0dfaf; } /* ControlFlow */
      code span.ch { color: #dca3a3; } /* Char */
      code span.cn { color: #dca3a3; font-weight: bold; } /* Constant */
      code span.co { color: #7f9f7f; } /* Comment */
      code span.cv { color: #7f9f7f; font-weight: bold; } /* CommentVar */
      code span.do { color: #7f9f7f; } /* Documentation */
      code span.dt { color: #dfdfbf; } /* DataType */
      code span.dv { color: #dcdccc; } /* DecVal */
      code span.er { color: #c3bf9f; } /* Error */
      code span.ex { } /* Extension */
      code span.fl { color: #c0bed1; } /* Float */
      code span.fu { color: #efef8f; } /* Function */
      code span.im { } /* Import */
      code span.in { color: #7f9f7f; font-weight: bold; } /* Information */
      code span.kw { color: #f0dfaf; } /* Keyword */
      code span.op { color: #f0efd0; } /* Operator */
      code span.ot { color: #efef8f; } /* Other */
      code span.pp { color: #ffcfaf; font-weight: bold; } /* Preprocessor */
      code span.sc { color: #dca3a3; } /* SpecialChar */
      code span.ss { color: #cc9393; } /* SpecialString */
      code span.st { color: #cc9393; } /* String */
      code span.va { } /* Variable */
      code span.vs { color: #cc9393; } /* VerbatimString */
      code span.wa { color: #7f9f7f; font-weight: bold; } /* Warning */
      }
    </style>
  <!-- Hand-rolled dark mode overrides for Pandoc's default CSS -->
  <!-- Credit: GitHub user ardabbour -->
    <style>
     @media (prefers-color-scheme: dark) {
      html {
        color: #ddd;
        background-color: #151515;
      }
      a {
        color: #abb2bf;
      }
      a:visited {
        color: #abb2bf;
      }
      hr {
        background-color: #abb2bf;
      }
      table {
        border-top: 1px solid #abb2bf;
        border-bottom: 1px solid #abb2bf;
      }
      th {
        border-top: 1px solid #abb2bf;
      }
      tbody {
        border-top: 1px solid #abb2bf;
        border-bottom: 1px solid #abb2bf;
      }
      blockquote {
        border-left: 2px solid #282c34;
        color: #5c6370;
      }
      figure > embed {
          filter: invert(0.8); /* yuck -- this part is Beej's fault*/
      }
     }
    </style>
  <!-- BG custom styling -->
  <style type="text/css">
  /* Fix for line numbers not visible */
  pre.numberSource code > span {
      left: -1em;
  }
  pre.numberSource {
      margin-left: initial;
  }

  /* Put some space after the section numbers */
  span.toc-section-number::after {
      content: "\a0\a0\a0";  /* non-breaking whitespace */
  }

  /* Hide underlines on code number links */
  pre > code.sourceCode > span > a:first-child::before {
      text-decoration: none;
  }

  /* Color the source blocks */
  div.sourceCode {
      /* background-color: #f0f0f0; */
  }

  /* Fix iOS big text rendering issue */
  pre > code.sourceCode > span {
      display: initial;
  }


  /* Color the inline code */
  code:not(.sourceCode) {
      /* background: #f0f0f0; */
      padding-left: 0.2em;
      padding-right: 0.2em;
      border-radius: 0.2em;
  }

  pre.sourceCode {
      border: 1px solid #ccc;
      padding: 0.5em;
      border-radius: 0.2em;
  }

  /* Keep code tags from wrapping in tables */
  tbody code {
      white-space: nowrap;
  }

  /* Prevent hyphenation and hyphen breaks in code*/
  code {
      word-break: keep-all;
  }

  td {
      vertical-align: top;
  }

  body {
      font-size: 12pt;
      max-width: 43em;
      font-family: sans-serif;
  }

  html {
      /* background: #f9f9f9; */
  }

  figure > embed {
      max-width: 100%;
  }

  figure {
      text-align: center;
      margin-top: 2em;
      margin-bottom: 2em;
  }

  figcaption {
      font-size: 0.9em;
      font-style: italic;
      margin-top: 0.6em;
  }

  body {
      counter-reset: figure-counter-major;
      counter-reset: figure-counter-minor;
  }

  figure {
      counter-increment: figure-counter-minor;
  }

  figcaption::before {
      content: "Figure " counter(figure-counter-major) "." counter(figure-counter-minor) ": ";
  }

  blockquote {
      border-left: 2px solid #bbb;
      /*color: #444;*/
  }

  /* Contents */

  nav[role="doc-toc"] > ul > li {
    font-weight: bold;
    margin-top: 1.2em;
  }

  nav[role="doc-toc"] > ul > li:first {
    font-weight: bold;
    margin-top: initial;
  }

  nav[role="doc-toc"] > ul > li > ul {
    font-weight: normal;
    margin-top: 0.3em;
  }

  /*
  In multipage, we need to reset the figure counter to the chapter
  number. Luckily, this is in the <h1 data-number> attribute. Unluckily,
  there is no way to get this in a general way.

  This doesn't work:

    h1[data-number] {
      counter-set: figure-counter-major attr(data-number);
    }

  Nor this:

    h1[data-number] {
      --figure-counter-major-value: attr(data-number);
      counter-set: figure-counter-major var(--figure-counter-major-value);
    }

  So, dumbly, we have a bunch of rules for all these sections, up to the
  maximum possible section.

  Here's a program to generate them:

    for (let i = 1; i < 100; i++)
        console.log(`h1[data-number="${i}"]{counter-set:figure-counter-major ${i};counter-reset:figure-counter-minor;}`);

  Note to self: never write a book with more than 99 frickin' chapters.
  */

  h1[data-number="1"]{counter-set:figure-counter-major 1;counter-reset:figure-counter-minor;}
  h1[data-number="2"]{counter-set:figure-counter-major 2;counter-reset:figure-counter-minor;}
  h1[data-number="3"]{counter-set:figure-counter-major 3;counter-reset:figure-counter-minor;}
  h1[data-number="4"]{counter-set:figure-counter-major 4;counter-reset:figure-counter-minor;}
  h1[data-number="5"]{counter-set:figure-counter-major 5;counter-reset:figure-counter-minor;}
  h1[data-number="6"]{counter-set:figure-counter-major 6;counter-reset:figure-counter-minor;}
  h1[data-number="7"]{counter-set:figure-counter-major 7;counter-reset:figure-counter-minor;}
  h1[data-number="8"]{counter-set:figure-counter-major 8;counter-reset:figure-counter-minor;}
  h1[data-number="9"]{counter-set:figure-counter-major 9;counter-reset:figure-counter-minor;}
  h1[data-number="10"]{counter-set:figure-counter-major 10;counter-reset:figure-counter-minor;}
  h1[data-number="11"]{counter-set:figure-counter-major 11;counter-reset:figure-counter-minor;}
  h1[data-number="12"]{counter-set:figure-counter-major 12;counter-reset:figure-counter-minor;}
  h1[data-number="13"]{counter-set:figure-counter-major 13;counter-reset:figure-counter-minor;}
  h1[data-number="14"]{counter-set:figure-counter-major 14;counter-reset:figure-counter-minor;}
  h1[data-number="15"]{counter-set:figure-counter-major 15;counter-reset:figure-counter-minor;}
  h1[data-number="16"]{counter-set:figure-counter-major 16;counter-reset:figure-counter-minor;}
  h1[data-number="17"]{counter-set:figure-counter-major 17;counter-reset:figure-counter-minor;}
  h1[data-number="18"]{counter-set:figure-counter-major 18;counter-reset:figure-counter-minor;}
  h1[data-number="19"]{counter-set:figure-counter-major 19;counter-reset:figure-counter-minor;}
  h1[data-number="20"]{counter-set:figure-counter-major 20;counter-reset:figure-counter-minor;}
  h1[data-number="21"]{counter-set:figure-counter-major 21;counter-reset:figure-counter-minor;}
  h1[data-number="22"]{counter-set:figure-counter-major 22;counter-reset:figure-counter-minor;}
  h1[data-number="23"]{counter-set:figure-counter-major 23;counter-reset:figure-counter-minor;}
  h1[data-number="24"]{counter-set:figure-counter-major 24;counter-reset:figure-counter-minor;}
  h1[data-number="25"]{counter-set:figure-counter-major 25;counter-reset:figure-counter-minor;}
  h1[data-number="26"]{counter-set:figure-counter-major 26;counter-reset:figure-counter-minor;}
  h1[data-number="27"]{counter-set:figure-counter-major 27;counter-reset:figure-counter-minor;}
  h1[data-number="28"]{counter-set:figure-counter-major 28;counter-reset:figure-counter-minor;}
  h1[data-number="29"]{counter-set:figure-counter-major 29;counter-reset:figure-counter-minor;}
  h1[data-number="30"]{counter-set:figure-counter-major 30;counter-reset:figure-counter-minor;}
  h1[data-number="31"]{counter-set:figure-counter-major 31;counter-reset:figure-counter-minor;}
  h1[data-number="32"]{counter-set:figure-counter-major 32;counter-reset:figure-counter-minor;}
  h1[data-number="33"]{counter-set:figure-counter-major 33;counter-reset:figure-counter-minor;}
  h1[data-number="34"]{counter-set:figure-counter-major 34;counter-reset:figure-counter-minor;}
  h1[data-number="35"]{counter-set:figure-counter-major 35;counter-reset:figure-counter-minor;}
  h1[data-number="36"]{counter-set:figure-counter-major 36;counter-reset:figure-counter-minor;}
  h1[data-number="37"]{counter-set:figure-counter-major 37;counter-reset:figure-counter-minor;}
  h1[data-number="38"]{counter-set:figure-counter-major 38;counter-reset:figure-counter-minor;}
  h1[data-number="39"]{counter-set:figure-counter-major 39;counter-reset:figure-counter-minor;}
  h1[data-number="40"]{counter-set:figure-counter-major 40;counter-reset:figure-counter-minor;}
  h1[data-number="41"]{counter-set:figure-counter-major 41;counter-reset:figure-counter-minor;}
  h1[data-number="42"]{counter-set:figure-counter-major 42;counter-reset:figure-counter-minor;}
  h1[data-number="43"]{counter-set:figure-counter-major 43;counter-reset:figure-counter-minor;}
  h1[data-number="44"]{counter-set:figure-counter-major 44;counter-reset:figure-counter-minor;}
  h1[data-number="45"]{counter-set:figure-counter-major 45;counter-reset:figure-counter-minor;}
  h1[data-number="46"]{counter-set:figure-counter-major 46;counter-reset:figure-counter-minor;}
  h1[data-number="47"]{counter-set:figure-counter-major 47;counter-reset:figure-counter-minor;}
  h1[data-number="48"]{counter-set:figure-counter-major 48;counter-reset:figure-counter-minor;}
  h1[data-number="49"]{counter-set:figure-counter-major 49;counter-reset:figure-counter-minor;}
  h1[data-number="50"]{counter-set:figure-counter-major 50;counter-reset:figure-counter-minor;}
  h1[data-number="51"]{counter-set:figure-counter-major 51;counter-reset:figure-counter-minor;}
  h1[data-number="52"]{counter-set:figure-counter-major 52;counter-reset:figure-counter-minor;}
  h1[data-number="53"]{counter-set:figure-counter-major 53;counter-reset:figure-counter-minor;}
  h1[data-number="54"]{counter-set:figure-counter-major 54;counter-reset:figure-counter-minor;}
  h1[data-number="55"]{counter-set:figure-counter-major 55;counter-reset:figure-counter-minor;}
  h1[data-number="56"]{counter-set:figure-counter-major 56;counter-reset:figure-counter-minor;}
  h1[data-number="57"]{counter-set:figure-counter-major 57;counter-reset:figure-counter-minor;}
  h1[data-number="58"]{counter-set:figure-counter-major 58;counter-reset:figure-counter-minor;}
  h1[data-number="59"]{counter-set:figure-counter-major 59;counter-reset:figure-counter-minor;}
  h1[data-number="60"]{counter-set:figure-counter-major 60;counter-reset:figure-counter-minor;}
  h1[data-number="61"]{counter-set:figure-counter-major 61;counter-reset:figure-counter-minor;}
  h1[data-number="62"]{counter-set:figure-counter-major 62;counter-reset:figure-counter-minor;}
  h1[data-number="63"]{counter-set:figure-counter-major 63;counter-reset:figure-counter-minor;}
  h1[data-number="64"]{counter-set:figure-counter-major 64;counter-reset:figure-counter-minor;}
  h1[data-number="65"]{counter-set:figure-counter-major 65;counter-reset:figure-counter-minor;}
  h1[data-number="66"]{counter-set:figure-counter-major 66;counter-reset:figure-counter-minor;}
  h1[data-number="67"]{counter-set:figure-counter-major 67;counter-reset:figure-counter-minor;}
  h1[data-number="68"]{counter-set:figure-counter-major 68;counter-reset:figure-counter-minor;}
  h1[data-number="69"]{counter-set:figure-counter-major 69;counter-reset:figure-counter-minor;}
  h1[data-number="70"]{counter-set:figure-counter-major 70;counter-reset:figure-counter-minor;}
  h1[data-number="71"]{counter-set:figure-counter-major 71;counter-reset:figure-counter-minor;}
  h1[data-number="72"]{counter-set:figure-counter-major 72;counter-reset:figure-counter-minor;}
  h1[data-number="73"]{counter-set:figure-counter-major 73;counter-reset:figure-counter-minor;}
  h1[data-number="74"]{counter-set:figure-counter-major 74;counter-reset:figure-counter-minor;}
  h1[data-number="75"]{counter-set:figure-counter-major 75;counter-reset:figure-counter-minor;}
  h1[data-number="76"]{counter-set:figure-counter-major 76;counter-reset:figure-counter-minor;}
  h1[data-number="77"]{counter-set:figure-counter-major 77;counter-reset:figure-counter-minor;}
  h1[data-number="78"]{counter-set:figure-counter-major 78;counter-reset:figure-counter-minor;}
  h1[data-number="79"]{counter-set:figure-counter-major 79;counter-reset:figure-counter-minor;}
  h1[data-number="80"]{counter-set:figure-counter-major 80;counter-reset:figure-counter-minor;}
  h1[data-number="81"]{counter-set:figure-counter-major 81;counter-reset:figure-counter-minor;}
  h1[data-number="82"]{counter-set:figure-counter-major 82;counter-reset:figure-counter-minor;}
  h1[data-number="83"]{counter-set:figure-counter-major 83;counter-reset:figure-counter-minor;}
  h1[data-number="84"]{counter-set:figure-counter-major 84;counter-reset:figure-counter-minor;}
  h1[data-number="85"]{counter-set:figure-counter-major 85;counter-reset:figure-counter-minor;}
  h1[data-number="86"]{counter-set:figure-counter-major 86;counter-reset:figure-counter-minor;}
  h1[data-number="87"]{counter-set:figure-counter-major 87;counter-reset:figure-counter-minor;}
  h1[data-number="88"]{counter-set:figure-counter-major 88;counter-reset:figure-counter-minor;}
  h1[data-number="89"]{counter-set:figure-counter-major 89;counter-reset:figure-counter-minor;}
  h1[data-number="90"]{counter-set:figure-counter-major 90;counter-reset:figure-counter-minor;}
  h1[data-number="91"]{counter-set:figure-counter-major 91;counter-reset:figure-counter-minor;}
  h1[data-number="92"]{counter-set:figure-counter-major 92;counter-reset:figure-counter-minor;}
  h1[data-number="93"]{counter-set:figure-counter-major 93;counter-reset:figure-counter-minor;}
  h1[data-number="94"]{counter-set:figure-counter-major 94;counter-reset:figure-counter-minor;}
  h1[data-number="95"]{counter-set:figure-counter-major 95;counter-reset:figure-counter-minor;}
  h1[data-number="96"]{counter-set:figure-counter-major 96;counter-reset:figure-counter-minor;}
  h1[data-number="97"]{counter-set:figure-counter-major 97;counter-reset:figure-counter-minor;}
  h1[data-number="98"]{counter-set:figure-counter-major 98;counter-reset:figure-counter-minor;}
  h1[data-number="99"]{counter-set:figure-counter-major 99;counter-reset:figure-counter-minor;}


  </style>
</head>
<body>
<div style="text-align:center"><span><a href="project-port-scanning.html" rel="prev">Prev</a> | </span><a href="index.html">Contents</a><span> | <a href="appendix-bitwise.html" rel="next">Next</a></span></div><hr>
<h1 data-number="39" id="project-multiuser-chat-client-and-server"><span class="header-section-number">39</span> Project: Multiuser Chat Client and Server</h1>
<p>It’s time to put it all together into this, the final project!</p>
<p>We’re going to build a multiuser chat server and a chat client to go along with it.</p>
<p>The chat server should allow an arbitrary number of connections from clients. All the clients will see what the other ones are saying.</p>
<p>Not only that, but there should be messages for when a user joins or leaves the chat.</p>
<p>Here’s a sample screenshot. The prompt where this user (“pat” in this example) is typing what they’re about to say. The region above it is where all the output accumulates.</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb243-1"><a href="project-multiuser-chat-client-and-server.html#cb243-1" aria-hidden="true" tabindex="-1"></a>*** pat has joined the chat</span>
<span id="cb243-2"><a href="project-multiuser-chat-client-and-server.html#cb243-2" aria-hidden="true" tabindex="-1"></a>pat: Hello?</span>
<span id="cb243-3"><a href="project-multiuser-chat-client-and-server.html#cb243-3" aria-hidden="true" tabindex="-1"></a>*** leslie has joined the chat</span>
<span id="cb243-4"><a href="project-multiuser-chat-client-and-server.html#cb243-4" aria-hidden="true" tabindex="-1"></a>leslie: hi everyone!</span>
<span id="cb243-5"><a href="project-multiuser-chat-client-and-server.html#cb243-5" aria-hidden="true" tabindex="-1"></a>pat: hows it going</span>
<span id="cb243-6"><a href="project-multiuser-chat-client-and-server.html#cb243-6" aria-hidden="true" tabindex="-1"></a>*** chris has joined the chat</span>
<span id="cb243-7"><a href="project-multiuser-chat-client-and-server.html#cb243-7" aria-hidden="true" tabindex="-1"></a>chris: OK, now we can start!</span>
<span id="cb243-8"><a href="project-multiuser-chat-client-and-server.html#cb243-8" aria-hidden="true" tabindex="-1"></a>pat: lol</span>
<span id="cb243-9"><a href="project-multiuser-chat-client-and-server.html#cb243-9" aria-hidden="true" tabindex="-1"></a>leslie: Why are you always last?</span>
<span id="cb243-10"><a href="project-multiuser-chat-client-and-server.html#cb243-10" aria-hidden="true" tabindex="-1"></a>*** chris has left the chat</span>
<span id="cb243-11"><a href="project-multiuser-chat-client-and-server.html#cb243-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-12"><a href="project-multiuser-chat-client-and-server.html#cb243-12" aria-hidden="true" tabindex="-1"></a>pat&gt; oh no!! :)█</span></code></pre></div>
<h2 data-number="39.1" id="overall-architecture"><span class="header-section-number">39.1</span> Overall Architecture</h2>
<p>There will be one server, and it will handle many simultaneous clients.</p>
<h3 data-number="39.1.1" id="server"><span class="header-section-number">39.1.1</span> Server</h3>
<p>The server will run using <code>select()</code> to handle multiple connections to see which ones are ready to read.</p>
<p>The listener socket itself will also be included in this set. When it shows “ready-to-read”, it means there’s a new connection to be <code>accept()</code>ed. If any of the other already-accepted sockets show “ready-to-read”, it means the client has sent some data that needs to be handled.</p>
<p>When the server get a chat packet from one client, it rebroadcasts that chat message to every connected client.</p>
<blockquote>
<p>Note: when we use the term “broadcast” here, we’re using it in the generic sense of sending a thing to a lot of people. We’re <strong>not</strong> talking about IP or Ethernet broadcast addresses. We won’t use those in this project.</p>
</blockquote>
<p>When a new client connects or disconnects, the server broadcasts that to all the clients, as well.</p>
<p>Since multiple clients will be sending data streams to the server, the server needs to maintain a packet buffer <em>for each client</em>.</p>
<blockquote>
<p>You can put this is a Python <code>dict</code> that uses the client’s socket itself as the key, so it maps from a socket to a buffer.</p>
</blockquote>
<p>The server will be launched by specifying a port number on the command line. This is mandatory; there is no default port.</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb244-1"><a href="project-multiuser-chat-client-and-server.html#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> chat_server.py 3490</span></code></pre></div>
<h3 data-number="39.1.2" id="client"><span class="header-section-number">39.1.2</span> Client</h3>
<p>When the client is launched, the user specifies their nickname (AKA “nick”) on the command line along with the server information.</p>
<p>The very first packet it sends is a “hello” packet that has the nickname in it. (This is how the server associates a connection with a nick and rebroadcasts the connection event to the other clients.)</p>
<p>After that, every line the user types into the client gets sent to the server as a chat packet.</p>
<p>Every chat packet (or connect or disconnect packet) the client gets from the server is shown on the output.</p>
<p>The client has a <strong>text user interface</strong> (TUI) that helps keep the output clean. Since the output is happening asynchronously on a different part of the screen than the input, we need to do some terminal magic to keep them from overwriting each other. This TUI code will be supplied and is described in the next section.</p>
<p>Since there can be data arriving while the user is typing something, we need a way to handle that. The client will be <strong>multithreaded</strong>. There will be two threads of execution.</p>
<ul>
<li>The main sending thread will:
<ul>
<li>Read keyboard input</li>
<li>Send chat messages from the user to the server</li>
</ul></li>
<li>The receiving thread will:
<ul>
<li>Receive packets from the server</li>
<li>Display those results on-screen</li>
</ul></li>
</ul>
<p>Since there is no shared data between those threads, no synchronization (mutexes, etc.) will be required.</p>
<blockquote>
<p>They do share the socket, but the OS makes sure that it’s OK for multiple threads to use that at the same time without an issue. It’s <em>threadsafe</em>.</p>
</blockquote>
<p>If you need more information on threading in Python, see the <a href="appendix-threading.html#appendix-threading">Appendix: Threading</a> section.</p>
<p>The client will be started by specifying the user’s nickname, the server address, and the server port on the command line. These are all required arguments; there are no defaults.</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb245-1"><a href="project-multiuser-chat-client-and-server.html#cb245-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> chat_client.py chris localhost 3490</span></code></pre></div>
<h2 data-number="39.2" id="client-io"><span class="header-section-number">39.2</span> Client I/O</h2>
<p>The client screen is split into two main regions:</p>
<ul>
<li>The input section, the last row or two of the screen.</li>
<li>The output section, the remaining top part of the screen.</li>
</ul>
<p>(The Client TUI section, below, has details about how to do this I/O.)</p>
<p>The client input line at the bottom of the screen should be the user’s nickname followed by <code>&gt;</code> and a space. The input takes place after that:</p>
<div class="sourceCode" id="cb246"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb246-1"><a href="project-multiuser-chat-client-and-server.html#cb246-1" aria-hidden="true" tabindex="-1"></a>alice&gt; this is some sample input</span></code></pre></div>
<p>The output area of the screen has two main types of messages:</p>
<ul>
<li><p><strong>Chat messages</strong>: these show the speaker nickname followed by <code>:</code> and a space, and then the message.</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb247-1"><a href="project-multiuser-chat-client-and-server.html#cb247-1" aria-hidden="true" tabindex="-1"></a>pat: hows it going</span></code></pre></div></li>
<li><p><strong>Informational messages</strong>: these show when a user has joined or left the chat, or any other information that needs printing. They consist of <code>***</code> followed by a space, then the message. Joining and leaving messages are shown here:</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb248-1"><a href="project-multiuser-chat-client-and-server.html#cb248-1" aria-hidden="true" tabindex="-1"></a>*** leslie has joined the chat</span>
<span id="cb248-2"><a href="project-multiuser-chat-client-and-server.html#cb248-2" aria-hidden="true" tabindex="-1"></a>*** chris has left the chat</span></code></pre></div></li>
</ul>
<h3 data-number="39.2.1" id="special-user-input"><span class="header-section-number">39.2.1</span> Special User Input</h3>
<p>If the user input begins with <code>/</code>, it has special meaning and should be parsed farther to determine the action.</p>
<p>Currently, the only special input defined is <code>/q</code>:</p>
<ul>
<li><strong><code>/q</code></strong>: if the user enters this, the client should exit. Nothing is sent to the server in this case.</li>
</ul>
<h2 data-number="39.3" id="the-client-tui"><span class="header-section-number">39.3</span> The Client TUI</h2>
<p><a href="https://beej.us/guide/bgnet0/source/exercises/chat/chatui.zip">Download the Chat UI code and demo here</a><a href="appendix-json.html#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a>.</p>
<p>In the file <code>chatui.py</code>, there are four functions you need, and you can get them with this import:</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb249-1"><a href="project-multiuser-chat-client-and-server.html#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> chatui <span class="im">import</span> init_windows, read_command, print_message, end_windows</span></code></pre></div>
<p>The functions are:</p>
<ul>
<li><p><strong>init_windows()</strong>: call this first before doing any other UI-oriented I/O of any kind. It should also be called before you start the receiver thread since that thread does I/O.</p></li>
<li><p><strong>end_windows()</strong>: call this when your program completes to clean everything up.</p></li>
<li><p><strong>read_command()</strong>: this prints a prompt out at the bottom of the screen and accepts user input. It returns the line the user entered once they hit the <code>ENTER</code> key.</p>
<p>For example:</p>
<div class="sourceCode" id="cb250"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb250-1"><a href="project-multiuser-chat-client-and-server.html#cb250-1" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> read_command(<span class="st">&quot;Enter something&gt; &quot;</span>)</span></code></pre></div>
<p>The function takes care of screen placement of the element.</p></li>
<li><p><strong>print_message()</strong>: Prints a message to the output portion of the screen. This handle scrolling and making sure the output doesn’t interfere with the input from <code>read_command()</code>.</p>
<p>Do not include a newline in your output. It will be added automatically.</p></li>
</ul>
<p><strong>Known Bug</strong>: on Mac, if something gets written by <code>print_message()</code>, then next backspace you type will show a <code>^R</code> and scroll down a line. It’s unclear why this happens.</p>
<h3 data-number="39.3.1" id="curses-variant-of-chatui"><span class="header-section-number">39.3.1</span> Curses Variant of <code>chatui</code></h3>
<p>If the <code>chatui</code> library is causing you trouble, you could try the alternate version <code>chatuicurses</code>. It has the exact same functions and is used in the exact same way.</p>
<p>Before you use it, you have to install the unicurses library:</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb251-1"><a href="project-multiuser-chat-client-and-server.html#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-m</span> pip install uni-curses</span></code></pre></div>
<p>After that installs, you should just be able to use <code>chatuicurses</code> instead of <code>chatui</code> in the import line.</p>
<p><strong>Known Mac Issue</strong>: my attempt complained that the curses library wasn’t installed when in fact it was. This doesn’t seem to affect Linux or Windows.</p>
<p><strong>One caveat</strong> here is that the input routine doesn’t obey <code>CRTL-C</code> to get out of the app. As such, you might have to hit <code>CTRL-C</code> followed by <code>RETURN</code> to actually break out. On Windows, you might try <code>CTRL-BREAK</code>.</p>
<h2 data-number="39.4" id="packet-structure"><span class="header-section-number">39.4</span> Packet Structure</h2>
<p>The client and server will communicate over TCP (stream) sockets using a defined packet structure.</p>
<p>In a nutshell, a packet is a 16-bit big-endian number representing the payload length. The payload is a string containing JSON-format data with UTF-8 encoding.</p>
<blockquote>
<p>You can encode the JSON string to UTF-8 bytes by calling <code>.encode()</code> on the string. <code>.encode()</code> takes an argument to specify the encoding, but it defaults to <code>"UTF-8"</code>.</p>
</blockquote>
<p>So the first thing you’ll have to do when looking at the data stream is make sure you have at least two bytes in your buffer so you can determine the JSON data length. And then after that, see if you have the length (plus 2 for the 2-byte header) in your buffer.</p>
<p>If you don’t, you’ll have to keep receiving data in a loop until you have enough. Also remember that you might receive some data from the next packet in a single <code>recv()</code> call.</p>
<p>Your code has to work no matter how many bytes are returned by <code>recv()</code>, even if it’s more or fewer than you expected!</p>
<p><strong>Have a <code>get_next_packet()</code> function</strong> that will extract and return the next packet, like you’ve done in earlier projects. Abstracting the byte stream into packets like this will make your life easier.</p>
<p>Also: be sure to use <code>sendall()</code> so that all the data you want sent actually gets sent!</p>
<h2 data-number="39.5" id="json-payloads"><span class="header-section-number">39.5</span> JSON Payloads</h2>
<p>If your JSON is rusty, check out the <a href="appendix-json.html#appendix-json">Appendix: JSON</a> section.</p>
<p>Each packet starts with the two-byte length of the payload, followed by the payload.</p>
<p>The payload is a UTF-8 encoded string representing a JSON object.</p>
<p>Each payload is an Object, and has a field in it named <code>"type"</code> that represents the type of the payload. The remaining fields vary based on the type.</p>
<p>In the following examples, square brackets in strings are used to indicate a place where you need to put in the relevant information. The brackets are <strong>not</strong> to be included in the packet.</p>
<h3 data-number="39.5.1" id="hello-payload"><span class="header-section-number">39.5.1</span> “Hello” Payload</h3>
<p>When a client first connects to a server, it sends a <code>hello</code> packet with the user’s nickname. This allows the server to associate a connection with a nick.</p>
<p>This MUST be sent before any other packets.</p>
<p>From client to server:</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb252-1"><a href="project-multiuser-chat-client-and-server.html#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb252-2"><a href="project-multiuser-chat-client-and-server.html#cb252-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;hello&quot;</span></span>
<span id="cb252-3"><a href="project-multiuser-chat-client-and-server.html#cb252-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;nick&quot;</span><span class="er">:</span> <span class="st">&quot;[user nickname]&quot;</span></span>
<span id="cb252-4"><a href="project-multiuser-chat-client-and-server.html#cb252-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h3 data-number="39.5.2" id="chat-payload"><span class="header-section-number">39.5.2</span> “Chat” Payload</h3>
<p>This represents a chat message. It has two forms depending on whether or not the chat message originated with the client (i.e. the user wants to send a message) or the server (i.e. the server is broadcasting someone else’s message).</p>
<p>From client to server:</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb253-1"><a href="project-multiuser-chat-client-and-server.html#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb253-2"><a href="project-multiuser-chat-client-and-server.html#cb253-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;chat&quot;</span></span>
<span id="cb253-3"><a href="project-multiuser-chat-client-and-server.html#cb253-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;message&quot;</span><span class="er">:</span> <span class="st">&quot;[message]&quot;</span></span>
<span id="cb253-4"><a href="project-multiuser-chat-client-and-server.html#cb253-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>From server to clients:</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb254-1"><a href="project-multiuser-chat-client-and-server.html#cb254-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb254-2"><a href="project-multiuser-chat-client-and-server.html#cb254-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;chat&quot;</span></span>
<span id="cb254-3"><a href="project-multiuser-chat-client-and-server.html#cb254-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;nick&quot;</span><span class="er">:</span> <span class="st">&quot;[sender nickname]&quot;</span></span>
<span id="cb254-4"><a href="project-multiuser-chat-client-and-server.html#cb254-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;message&quot;</span><span class="er">:</span> <span class="st">&quot;[message]&quot;</span></span>
<span id="cb254-5"><a href="project-multiuser-chat-client-and-server.html#cb254-5" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>The client doesn’t need to send the sender’s nick along with the packet since the server can already make that association from the <code>hello</code> packet sent earlier.</p>
<h3 data-number="39.5.3" id="join-payload"><span class="header-section-number">39.5.3</span> “Join” Payload</h3>
<p>The server sends this to all the clients when someone joins the chat.</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb255-1"><a href="project-multiuser-chat-client-and-server.html#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb255-2"><a href="project-multiuser-chat-client-and-server.html#cb255-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;join&quot;</span></span>
<span id="cb255-3"><a href="project-multiuser-chat-client-and-server.html#cb255-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;nick&quot;</span><span class="er">:</span> <span class="st">&quot;[joiner&#39;s nickname]&quot;</span></span>
<span id="cb255-4"><a href="project-multiuser-chat-client-and-server.html#cb255-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h3 data-number="39.5.4" id="leave-payload"><span class="header-section-number">39.5.4</span> “Leave” Payload</h3>
<p>The server sends this to all the clients when someone leaves the chat.</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb256-1"><a href="project-multiuser-chat-client-and-server.html#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb256-2"><a href="project-multiuser-chat-client-and-server.html#cb256-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;leave&quot;</span></span>
<span id="cb256-3"><a href="project-multiuser-chat-client-and-server.html#cb256-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;nick&quot;</span><span class="er">:</span> <span class="st">&quot;[leaver&#39;s nickname]&quot;</span></span>
<span id="cb256-4"><a href="project-multiuser-chat-client-and-server.html#cb256-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h2 data-number="39.6" id="extensions-2"><span class="header-section-number">39.6</span> Extensions</h2>
<p>These aren’t worth any points, but if you want to push farther, here are some ideas. <strong>Caveat!</strong> Be sure whatever you turn in has the official functionality as already described. These mods can be a strict superset of that, or you can fork a new project to hold them.</p>
<p>At the very least, I recommend branching from your working version so it doesn’t get accidentally messed up!</p>
<ul>
<li><p>Add direct messaging–if the user “pat” sends:</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb257-1"><a href="project-multiuser-chat-client-and-server.html#cb257-1" aria-hidden="true" tabindex="-1"></a>/message chris how&#39;s it going?</span></code></pre></div>
<p>then “chris” will see:</p>
<div class="sourceCode" id="cb258"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb258-1"><a href="project-multiuser-chat-client-and-server.html#cb258-1" aria-hidden="true" tabindex="-1"></a>pat -&gt; chris: how&#39;s it going?</span></code></pre></div>
<p>(What if the user doesn’t exist? Maybe you need to define an error packet to get back from the server!)</p></li>
<li><p>Add a way to list the names of all the people in the chat</p></li>
<li><p>Add emotes–if the user “pat” sends:</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb259-1"><a href="project-multiuser-chat-client-and-server.html#cb259-1" aria-hidden="true" tabindex="-1"></a>/me goes out to buy some snacky cakes</span></code></pre></div>
<p>everyone else sees:</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb260-1"><a href="project-multiuser-chat-client-and-server.html#cb260-1" aria-hidden="true" tabindex="-1"></a>[pat goes out to buy some snacky cakes]</span></code></pre></div>
<p>(The right way to do this is to add a new packet type!)</p></li>
<li><p>Add chat rooms–there could be a default room everyone is in when they first join, but additions could be to add chat rooms, join or leave chat rooms, and list available chat rooms.</p></li>
<li><p>Turn the whole thing into a <a href="https://en.wikipedia.org/wiki/Multi-user_dungeon">MUD</a>. That should keep you busy!</p></li>
</ul>
<h2 data-number="39.7" id="some-recommendations"><span class="header-section-number">39.7</span> Some Recommendations</h2>
<p>Here are some pointers that might help.</p>
<ul>
<li><p>Have the server use the set of connected sockets that it passes to <code>select()</code> as its canonical list of everyone who is connected.</p>
<p>If a client disconnects, remove them from the set.</p>
<p>If a new client connects, add them to the set.</p>
<p>The set will always reflect everyone who is connected at this time.</p></li>
<li><p>Have a buffer per connection on the server. Remember how we had a buffer in earlier projects that would accumulate data until there was a complete packet? We need one of those buffers <em>per connection</em>. And in this project, we have a lot of connections.</p>
<p>Use a <code>dict</code> to store the buffers. The key is the socket itself, and the value is a string with the buffer for that socket in it.</p></li>
<li><p>Remember the project where we wrote code to extract packets from the bytestring buffer?</p>
<p>Use that strategy again.</p></li>
<li><p>You’ll want to use <code>.to_bytes()</code> and <code>.from_bytes()</code> to get and set the packet length.</p></li>
<li><p>Use old projects as much as you can.</p></li>
</ul>
<!-- Rubric

5 points each

Client sends correct `chat` packet JSON (nickname not included)

Client sends correct `hello` packet JSON

Client handles `join` packet JSON

Client handles `leave` packet JSON

Client implements the text user interface from `chatui`

Client is multithreaded, one thread for receiving and one for input and sending

Client extracts len+JSON packets from stream correctly

Client JSON strings are UTF-8 encoded

Client encodes packets correctly with the length and JSON payload

Client accepts nickname, server, and port number on the command line

Client `/q` command implemented correctly

Server sends correct `chat` packet JSON

Server sends correct `join` packet JSON

Server sends correct `leave` packet JSON

Server handles `hello` packet JSON

Server uses select to handle multiple connections

Server extracts len+JSON packets from stream correctly

Server JSON strings are UTF-8 encoded

Server encodes packets correctly with the length and JSON payload

Server accepts port number on the command line
-->
<!-- BG_NEW_CHAPTER -->
<hr><div style="text-align:center"><span><a href="project-port-scanning.html" rel="prev">Prev</a> | </span><a href="index.html">Contents</a><span> | <a href="appendix-bitwise.html" rel="next">Next</a></span></div></body>
</html>
